
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  
  <title>間歇時鐘 MVP</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto; margin:0; background:#0b0f14; color:#e6eef7;}
    header { padding:12px 16px; border-bottom:1px solid #1f2937; display:flex; gap:16px; align-items:flex-end; flex-wrap:wrap; }
    header h1 { font-size:18px; margin:0; }
    nav button { background:#111827; border:1px solid #374151; padding:8px 12px; border-radius:8px; color:#cbd5e1; cursor:pointer;}
    nav button.active { background:#2563eb; border-color:#2563eb; color:white;}
    .container { padding:16px; max-width:980px; margin:0 auto;}
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px,1fr)); gap:12px;}
    .card { background:#111827; border:1px solid #374151; border-radius:12px; padding:12px;}
    .muted {color:#9ca3af;font-size:12px;}
    .row { display:flex; align-items:center; gap:8px; flex-wrap:wrap;}
    input, select { background:#0b1220; border:1px solid #334155; color:#e2e8f0; padding:8px; border-radius:8px; }
    input[type=number] { width:100px;}
    textarea { width:100%; background:#0b1220; color:#e2e8f0; border:1px solid #334155; border-radius:8px; padding:8px;}
    .btn { background:#2563eb; color:#fff; border:none; padding:8px 10px; border-radius:8px; cursor:pointer;}
    .btn.secondary { background:#374151;}
    .btn.danger { background:#b91c1c;}
    .badge { padding:2px 6px; border-radius:6px; font-size:12px; background:#0b1220; border:1px solid #334155;}
    .player { display:flex; align-items:center; gap:8px;}
    .stage-list { display:flex; flex-direction:column; gap:8px; }
    .stage-item { border:1px dashed #334155; border-radius:10px; padding:8px;}
    .footer { margin-top:40px; color:#94a3b8; font-size:12px; text-align:center;}
    #editor {
      max-height: 80vh;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 1rem;
    }

    /* 基本尺寸（非全螢幕） */
    #player .time        { font-size: 48px; line-height: 1.1; }
    #player .stage-title { font-size: 14px; }
    #player .next-label  { font-size: 12px; }

    /* 全螢幕時：用 vmin 依視窗最短邊等比例縮放（手機 / PC 都適用） */
    #player:fullscreen .time,
    #player:-webkit-full-screen .time {
      font-size: clamp(64px, 18vmin, 220px);
    }

    #player:fullscreen .stage-title,
    #player:-webkit-full-screen .stage-title {
      font-size: clamp(20px, 6vmin, 64px);
    }

    #player:fullscreen .next-label,
    #player:-webkit-full-screen .next-label {
      font-size: clamp(16px, 4vmin, 36px);
    }

    /* 全螢幕時把按鈕、間距也放大 */
    #player:fullscreen .row .btn,
    #player:-webkit-full-screen .row .btn {
      font-size: clamp(16px, 4vmin, 28px);
      padding: clamp(8px, 1.8vmin, 18px) clamp(12px, 2.4vmin, 24px);
      border-radius: clamp(8px, 1.8vmin, 18px);
    }

    #player:fullscreen #remain-txt,
    #player:-webkit-full-screen #remain-txt {
      margin-top: clamp(8px, 3vmin, 24px);
    }

    #player:fullscreen {
      width: 100vw !important;
      height: 100vh !important;
      inset: 0 !important;
      right: auto !important;
      bottom: auto !important;
      border-radius: 0 !important;
      display: flex;
      flex-direction: column;
      justify-content: center;
      background: #0b0f14;
    }
    .dropdown {
      position: relative;
      display: inline-block;
    }

    /* —— fallback：劇院模式（theater） —— */
    body.no-scroll { overflow: hidden; }
    #player.theater {
      position: fixed !important;
      inset: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      border-radius: 0 !important;
      background: #0b0f14;
      display: flex; flex-direction: column; justify-content: center;
      padding: max(12px, env(safe-area-inset-top))
              max(12px, env(safe-area-inset-right))
              max(12px, env(safe-area-inset-bottom))
              max(12px, env(safe-area-inset-left));
}

    .dropdown-menu {
      display: none;
      position: absolute;
      background-color: white;
      border: 1px solid #ccc;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 1000;
      min-width: 120px;
      border-radius: 4px;
      overflow: hidden;
    }

    .dropdown-menu .dropdown-item {
      padding: 8px 12px;
      cursor: pointer;
      font-size: 0.95rem;
      color: #333;
    }

    .dropdown-menu .dropdown-item:hover {
      background-color: #f0f0f0;
    }

    #profile-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.6);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 2000;
    }

    #profile-modal .modal-card {
      background: #0b1220;
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 20px;
      max-width: 520px;
      width: 100%;
    }

    #profile-modal label {
      display: block;
      margin-top: 12px;
    }

    #profile-modal input, #profile-modal select {
      width: 100%;
      margin-top: 6px;
    }

  </style>
</head>
<body>
<header>
  <div style="display:flex; flex-direction:column; gap:4px;">
    <h1>⏱️ 間歇時鐘 MVP</h1>
    <div id="user-nickname" class="muted">歡迎使用者</div>
  </div>
  <nav>
    <button id="tab-community" class="active">社群 Community</button>
    <button id="tab-team">團隊 Your Team</button>
    <button id="tab-your">個人 Your Timer</button>
  </nav>
  <div style="margin-left:auto;" class="row">
    <button id="btn-profile" class="btn secondary">個人設定</button>
    <button id="btn-logout" class="btn secondary">登出</button>
    <button id="btn-new" class="btn">＋ 新建時鐘</button>
    <button class="btn secondary" onclick="triggerImportJSON()">⭳ 匯入時鐘</button>
  </div>
</header>
<div class="container">
  <section id="view-community">
    <div class="row" style="margin-bottom:12px;">
      <input id="search" placeholder="搜尋名稱關鍵字（Enter）" />
      <span class="muted">點擊「加入到我的」即可複製到你的個人清單</span>
    </div>
    <div id="community-grid" class="grid"></div>
  </section>

  <section id="view-team" style="display:none;">
    <div class="card">
      <h3>團隊功能（開發中）</h3>
      <p class="muted">將支援共享、同步播放、權限管理等協作功能。</p>
    </div>
  </section>

  <section id="view-your" style="display:none;">
    <div id="your-grid" class="grid"></div>
  </section>

  <div class="footer">登入後可同步私人時鐘並自訂個人資料。訪客帳號僅支援建立公開時鐘。</div>
</div>

<!-- Profile Modal -->
<div id="profile-modal">
  <div class="modal-card">
    <div class="row" style="justify-content:space-between; align-items:center;">
      <h3 style="margin:0;">個人設定</h3>
      <button class="btn secondary" onclick="closeProfileModal()">關閉</button>
    </div>
    <p class="muted" style="margin-top:8px;">除暱稱外，其餘欄位皆為選填，方便調整教練或團隊顯示資訊。</p>
    <label>暱稱
      <input id="pf-display-name" placeholder="輸入你想被顯示的名稱" />
    </label>
    <label>性別
      <input id="pf-gender" placeholder="例如：男、女、非二元" />
    </label>
    <label>年齡
      <input id="pf-age" type="number" min="0" placeholder="年齡（可留空）" />
    </label>
    <label>身高 (cm)
      <input id="pf-height" type="number" min="0" step="0.1" placeholder="身高（公分）" />
    </label>
    <label>體重 (kg)
      <input id="pf-weight" type="number" min="0" step="0.1" placeholder="體重（公斤）" />
    </label>
    <div class="row" style="justify-content:flex-end; margin-top:16px;">
      <button class="btn secondary" onclick="closeProfileModal()">取消</button>
      <button class="btn" id="btn-profile-save">儲存</button>
    </div>
  </div>
</div>

<!-- Editor Dialog -->
<div id="editor" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6);">
  <div style="max-width:860px; margin:40px auto; background:#0b1220; border:1px solid #334155; border-radius:12px; padding:16px;">
    <div class="row" style="justify-content:space-between;">
      <h3 id="ed-title">編輯時鐘</h3>
      <button onclick="hideEditor()" class="btn secondary">關閉</button>
    </div>
    <div class="row" style="margin:8px 0;">
      <label>名稱 <input id="ed-name" /></label>
      <label>重複次數 <input id="ed-repeat" type="number" min="1" value="1"/></label>
      <label><input id="ed-public" type="checkbox"/> 公開</label>
    </div>
    <div class="row" style="margin:8px 0;">
      <label>BGM URL <input id="ed-bgm" style="width:420px;" placeholder="可留空"/></label>
    </div>

    <div class="row" style="justify-content:space-between; margin-top:12px;">
      <h4>段落（Stages）</h4>
      <div class="row">
        <button class="btn secondary" onclick="addStage()">＋ 新增段落</button>
        <button class="btn secondary" onclick="addSampleTabata()">＋ Tabata樣板</button>
      </div>
    </div>
    <div id="stage-list" class="stage-list"></div>
    <div class="row" style="justify-content:flex-end; margin-top:12px;">
      <button class="btn danger" onclick="deleteClock()">刪除</button>
      <button class="btn secondary" onclick="saveClock()">儲存</button>
      <button class="btn" onclick="playClock()">試播</button>
    </div>
  </div>
</div>

<script>
const $ = (q)=>document.querySelector(q);

function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
  return '';
}

const SAFE_METHODS = ['GET','HEAD','OPTIONS','TRACE'];

async function api(url, opt={}) {
  const options = Object.assign({method: 'GET'}, opt);
  options.headers = Object.assign({'Content-Type': 'application/json'}, options.headers || {});
  options.credentials = 'same-origin';
  const method = (options.method || 'GET').toUpperCase();
  if (!SAFE_METHODS.includes(method)) {
    options.headers['X-CSRFToken'] = getCookie('csrftoken');
  }
  const response = await fetch(url, options);
  if (response.status === 401) {
    window.location.href = '/login/';
    throw new Error('未登入');
  }
  return response;
}

let currentUser = null;

async function fetchCurrentUser(){
  const res = await api('/api/auth/me/');
  currentUser = await res.json();
  updateUserBadge();
  fillProfileForm();
}

function updateUserBadge(){
  const el = $('#user-nickname');
  if(!el) return;
  if(!currentUser){
    el.textContent = '歡迎使用者';
    return;
  }
  const name = currentUser.display_name || (currentUser.is_guest ? '訪客使用者' : '未命名使用者');
  el.textContent = `👋 ${name}`;
}

function fillProfileForm(){
  if(!currentUser) return;
  $('#pf-display-name').value = currentUser.display_name || '';
  $('#pf-gender').value = currentUser.gender || '';
  $('#pf-age').value = currentUser.age ?? '';
  $('#pf-height').value = currentUser.height_cm ?? '';
  $('#pf-weight').value = currentUser.weight_kg ?? '';
}

function openProfileModal(){
  fillProfileForm();
  const modal = $('#profile-modal');
  if(modal){
    modal.style.display = 'flex';
  }
}

function closeProfileModal(){
  const modal = $('#profile-modal');
  if(modal){
    modal.style.display = 'none';
  }
}

async function saveProfile(){
  const payload = {
    display_name: $('#pf-display-name').value.trim(),
    gender: $('#pf-gender').value.trim(),
    age: $('#pf-age').value ? Number($('#pf-age').value) : null,
    height_cm: $('#pf-height').value ? Number($('#pf-height').value) : null,
    weight_kg: $('#pf-weight').value ? Number($('#pf-weight').value) : null,
  };
  const res = await api('/api/auth/me/', {method:'PATCH', body: JSON.stringify(payload)});
  if(!res.ok){
    const data = await res.json().catch(()=>({detail:'更新失敗'}));
    alert(data.detail || '儲存失敗');
    return;
  }
  currentUser = await res.json();
  updateUserBadge();
  closeProfileModal();
  alert('個人資料已更新');
}

// Tabs
function showTab(id){
  ['community','team','your'].forEach(t=>{
    $('#view-'+t).style.display = (t===id)?'block':'none';
    $('#tab-'+t).classList.toggle('active', t===id);
  });
}
$('#tab-community').onclick = ()=>{ showTab('community'); loadCommunity(); };
$('#tab-team').onclick = ()=>{ showTab('team'); };
$('#tab-your').onclick = ()=>{ showTab('your'); loadMine(); };
$('#btn-profile').onclick = ()=>{ openProfileModal(); };
$('#btn-profile-save').onclick = ()=>{ saveProfile(); };
$('#profile-modal').addEventListener('click', (e)=>{ if(e.target.id==='profile-modal'){ closeProfileModal(); }});
$('#btn-logout').onclick = async ()=>{
  await api('/api/auth/logout/', {method:'POST', body: JSON.stringify({})});
  window.location.href = '/login/';
};

// Loaders
async function loadCommunity(){
  const res = await api('/api/clocks/?public=1');
  const data = await res.json();
  const grid = $('#community-grid'); grid.innerHTML = '';
  data.forEach(c=>grid.appendChild(clockCard(c, false)));
}
async function loadMine(){
  if(!currentUser) return;
  const res = await api('/api/clocks/?mine=1');
  const data = await res.json();
  const grid = $('#your-grid'); grid.innerHTML = '';
  data.forEach(c=>grid.appendChild(clockCard(c, true)));
}

function triggerImportJSON() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = () => {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const clock = JSON.parse(e.target.result);
        delete clock.id;               // 關鍵：視為新建
        delete clock.created_at;
        delete clock.updated_at;
        delete clock.user;
        if (!Array.isArray(clock.stages)) { alert('❌ 匯入失敗：缺少 stages'); return; }
        clock.stages.forEach(s => delete s.id);  // 以防萬一
        openEditor(clock);            // 進編輯器；第一次儲存會走 POST
      } catch {
        alert('❌ 匯入失敗：不是合法的 JSON 檔案');
      }
    };
    reader.readAsText(file);
  };
  input.click();
}




// Cards
function clockCard(c, mine) {
  const el = document.createElement('div');
  el.className = 'card';
  const total = c.stages.reduce((t, s) => t + Number(s.duration_sec || 0), 0);
  const totalMin = Math.floor(total / 60), totalSec = total % 60;

  el.innerHTML = `
    <div class="row" style="justify-content:space-between;">
      <div>
        <div style="font-weight:700;">${c.name}</div>
        <div class="muted">${c.stages.length} 段｜總時長 ${totalMin}:${String(totalSec).padStart(2, '0')}｜重複 ${c.repeat_count} 次</div>
      </div>
      <div class="row">
        <span class="badge">${c.is_public ? '公開' : '私人'}</span>
      </div>
    </div>
    <div class="row" style="margin-top:8px;">
      ${mine ? `<button class="btn secondary" onclick='openEditor(${JSON.stringify(c)})'>編輯</button>` : ''}
      <button class="btn" onclick='playInline(${JSON.stringify(c)})'>播放</button>
      ${mine ? '' : `<button class="btn secondary" onclick='forkClock(${c.id})'>加入到我的</button>`}
      <div class="dropdown">
        <button class="btn secondary">匯出 ▼</button>
        <div class="dropdown-menu" style="display:none;position:absolute;z-index:100;">
          <div class="dropdown-item" onclick="alert('MP4 匯出功能尚在開發中')">MP4 (開發中)</div>
          <div class="dropdown-item" onclick='exportClockJSON(${JSON.stringify(c)})'>JSON</div>
        </div>
      </div>
    </div>
  `;

  // 讓 dropdown 展開
  setTimeout(() => {
    const dropdown = el.querySelector('.dropdown');
    const menu = dropdown.querySelector('.dropdown-menu');
    const btn = dropdown.querySelector('button');
    btn.onclick = () => {
      menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    };
    document.addEventListener('click', e => {
      if (!dropdown.contains(e.target)) menu.style.display = 'none';
    });
  }, 0);

  return el;
}

function exportClockJSON(clock) {
  const dataStr = JSON.stringify(clock, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${clock.name || 'clock'}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
// Create new
$('#btn-new').onclick = async ()=>{
  const payload = {name:'未命名時鐘', repeat_count:1, is_public: currentUser && currentUser.is_guest ? true : false, bgm_url:null, stages:[]};
  const res = await api('/api/clocks/', {method:'POST', body: JSON.stringify(payload)});
  const data = await res.json();
  if(!res.ok){
    alert(data.detail || '建立失敗');
    return;
  }
  openEditor(data);
};

// Fork
async function forkClock(id){
  const res = await api(`/api/clocks/${id}/fork/`, {method:'POST'});
  if(res.ok){
    alert('已加入到我的');
    showTab('your'); loadMine();
  }else{
    const j = await res.json(); alert(j.detail || '失敗');
  }
}

// Editor
let currentClock = null;
function openEditor(c){
  currentClock = JSON.parse(JSON.stringify(c));
  $('#ed-title').textContent = `編輯：${c.name}`;
  $('#ed-name').value = c.name;
  $('#ed-repeat').value = c.repeat_count;
  const isGuest = currentUser && currentUser.is_guest;
  const publicToggle = $('#ed-public');
  publicToggle.checked = isGuest ? true : !!c.is_public;
  publicToggle.disabled = !!isGuest;
  publicToggle.parentElement.title = isGuest ? '訪客帳號只能建立公開時鐘' : '';
  $('#ed-bgm').value = c.bgm_url || '';
  addWarmUpIfNeeded();
  renderStages();
  $('#editor').style.display = 'block';
}
function hideEditor(){ $('#editor').style.display = 'none'; }
function addStage(){
  currentClock.stages.push({order_index: currentClock.stages.length+1, name:'', duration_sec:10, tts_enabled:true, speak_every_sec:10, countdown_speak_from_sec:5, cue_beep_last_n_sec:3, voice_volume:1, voice_rate:1, voice_pitch:1, bgm_volume_override:null});
  renderStages();
}
function addSampleTabata(){
  currentClock.stages = [];
  currentClock.stages.push({order_index:1, name:'Warm-up', duration_sec:60, tts_enabled:true, speak_every_sec:0, countdown_speak_from_sec:10, cue_beep_last_n_sec:3, voice_volume:1, voice_rate:1, voice_pitch:1, bgm_volume_override:null});
  for(let i=0;i<8;i++){
    currentClock.stages.push({order_index:2+i*2, name:`Work ${i+1}`, duration_sec:20, tts_enabled:true, speak_every_sec:10, countdown_speak_from_sec:10, cue_beep_last_n_sec:3, voice_volume:1, voice_rate:1, voice_pitch:1, bgm_volume_override:null});
    currentClock.stages.push({order_index:3+i*2, name:`Rest ${i+1}`, duration_sec:10, tts_enabled:true, speak_every_sec:0, countdown_speak_from_sec:5, cue_beep_last_n_sec:3, voice_volume:1, voice_rate:1, voice_pitch:1, bgm_volume_override:null});
  }
  renderStages();
}

function addWarmUpIfNeeded() {
  const first = currentClock.stages[0];
  const isWarm = first && (/^warm-?up$/i.test((first.name||'').trim()) || first.name === '預備');
  if (!isWarm) {
    currentClock.stages.unshift({
      order_index: 1,
      name: 'Warm-Up',  // 建議固定
      duration_sec: 20,
      tts_enabled: true,
      speak_every_sec:5, countdown_speak_from_sec:5, cue_beep_last_n_sec:3,
      voice_volume:1, voice_rate:1, voice_pitch:1, bgm_volume_override:null
    });
  }
  currentClock.stages.forEach((s,i)=>s.order_index=i+1);
}



function duplicateStage(index) {
  const s = currentClock.stages[index];
  const copy = JSON.parse(JSON.stringify(s));
  currentClock.stages.push(copy);
  renderStages();
}

function renderStages() {
  const list = $('#stage-list');
  list.innerHTML = '';

  currentClock.stages.forEach((s, idx) => {
    const d = document.createElement('div');
    d.className = 'stage-item';
    d.setAttribute('data-index', idx);  // for drag-and-drop

    d.innerHTML = `
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div class="row">
          <span class="drag-handle" style="cursor:grab;margin-right:6px;">☰</span>
          <span class="badge">#${idx + 1}</span>
          <label>名稱 <input value="${s.name || ''}" oninput="currentClock.stages[${idx}].name=this.value"/></label>
          <label>秒數 <input type="number" min="1" value="${s.duration_sec}" oninput="currentClock.stages[${idx}].duration_sec=Number(this.value)"/></label>
          <label>語音 <input type="checkbox" ${s.tts_enabled ? 'checked' : ''} onchange="currentClock.stages[${idx}].tts_enabled=this.checked"/></label>
        </div>
        <div class="row">
          <button class="btn secondary" onclick="moveStage(${idx},-1)">上移</button>
          <button class="btn secondary" onclick="moveStage(${idx},1)">下移</button>
          <button class="btn secondary" onclick="duplicateStage(${idx})">複製</button>
          <button class="btn danger" onclick="removeStage(${idx})">刪除</button>
        </div>
      </div>
      <div class="row" style="margin-top:6px;">
        <label>報秒頻率 <input type="number" min="0" value="${s.speak_every_sec}" oninput="currentClock.stages[${idx}].speak_every_sec=Number(this.value)"/></label>
        <label>倒數起點 <input type="number" min="0" value="${s.countdown_speak_from_sec}" oninput="currentClock.stages[${idx}].countdown_speak_from_sec=Number(this.value)"/></label>
        <label>尾段蜂鳴 <input type="number" min="0" value="${s.cue_beep_last_n_sec}" oninput="currentClock.stages[${idx}].cue_beep_last_n_sec=Number(this.value)"/></label>
      </div>
    `;
    list.appendChild(d);
  });
}
function moveStage(i, dir){
  const j = i+dir; if(j<0||j>=currentClock.stages.length) return;
  const tmp = currentClock.stages[i]; currentClock.stages[i]=currentClock.stages[j]; currentClock.stages[j]=tmp;
  currentClock.stages.forEach((s,k)=>s.order_index=k+1);
  renderStages();
}
function removeStage(i){
  currentClock.stages.splice(i,1);
  currentClock.stages.forEach((s,k)=>s.order_index=k+1);
  renderStages();
}

async function saveClock(){
  currentClock.name = $('#ed-name').value.trim() || '未命名時鐘';
  currentClock.repeat_count = Number($('#ed-repeat').value)||1;
  currentClock.is_public = $('#ed-public').checked;
  currentClock.bgm_url = $('#ed-bgm').value || null;

  const isNew = !currentClock.id;
  const url = isNew ? '/api/clocks/' : `/api/clocks/${currentClock.id}/`;
  const method = isNew ? 'POST' : 'PUT';

  const res = await api(url, { method, body: JSON.stringify(currentClock) });
  const saved = await res.json();
  if(!res.ok){
    alert(saved.detail || '儲存失敗');
    return;
  }
  currentClock = saved;       // 重要：POST 後拿回 id，之後才會用 PUT
  alert('已儲存');
  hideEditor();
  loadMine();
}

async function deleteClock(){
  if(!confirm('確定刪除此時鐘？')) return;
  const res = await api(`/api/clocks/${currentClock.id}/`, {method:'DELETE', body: JSON.stringify({})});
  if(res.ok){
    hideEditor();
    loadMine();
  }else{
    const data = await res.json().catch(()=>({detail:'刪除失敗'}));
    alert(data.detail || '刪除失敗');
  }
}

// Player (simple, setInterval-based UI updates, with Web Speech & Audio for cues)
let playing = false, timerState = null, intervalId = null, audioCtx=null, bgmEl=null;

function speak(text, rate=1, pitch=1, volume=1){
  if(!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'zh-TW';
  u.rate = rate; u.pitch = pitch; u.volume = volume;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}

function beep(){
  if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type='sine'; o.frequency.value=880;
  g.gain.setValueAtTime(0.001, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.2, audioCtx.currentTime+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.15);
  o.connect(g).connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime+0.16);
}

function playInline(c){ openPlayer(c); }
function playClock(){ openPlayer(currentClock); }

function openPlayer(clock){
  if(!clock.stages.length){ alert('請先新增段落'); return; }
  // init BGM
  if(clock.bgm_url){
    if(!bgmEl){ bgmEl = new Audio(); bgmEl.loop = true; }
    bgmEl.src = clock.bgm_url;
    bgmEl.volume = 0.4;
    bgmEl.play().catch(()=>{});
  }
  timerState = {clock, loop:1, idx:0, remain: clock.stages[0].duration_sec};
  playing = true;
  // greeting
  const s = clock.stages[0];
  if(s.tts_enabled && (s.name||'').trim()){ speak(s.name); }
  renderPlayer();
  if(intervalId) clearInterval(intervalId);
  intervalId = setInterval(tick, 1000);

}

function stopPlayer(){
  playing = false;
  if(intervalId) { clearInterval(intervalId); intervalId=null; }
  if(bgmEl){ bgmEl.pause(); }
  $('#player').remove();
}
function nextStage(){
  const {clock} = timerState;
  timerState.idx += 1;
  if(timerState.idx >= clock.stages.length){
    timerState.loop += 1;
    if(timerState.loop > (clock.repeat_count||1)){
      alert('完成！'); stopPlayer(); return;
    }
    timerState.idx = 0;
  }
  const s = clock.stages[timerState.idx];
  timerState.remain = s.duration_sec;
  if(s.tts_enabled && (s.name||'').trim()){ speak(s.name); }
  renderPlayer();
}

function tick(){
  if(!playing) return;   
  if (isPaused) return; // ✅ 暫停時直接返回（不扣秒、不發聲）
  timerState.remain -= 1;
  const s = timerState.clock.stages[timerState.idx];
  // speak every n seconds
  if(s.tts_enabled && s.speak_every_sec>0){
    const elapsed = s.duration_sec - timerState.remain;
    if(elapsed>0 && elapsed % s.speak_every_sec === 0){
      speak(String(timerState.remain));
    }
  }
  // countdown stage
  if(s.tts_enabled && s.countdown_speak_from_sec>0 && timerState.remain <= s.countdown_speak_from_sec){
    speak(String(timerState.remain));
  }
  // beeps
  if(s.cue_beep_last_n_sec>0 && timerState.remain <= s.cue_beep_last_n_sec){
    beep();
  }
  if(timerState.remain <= 0){
    nextStage();
  }else{
    renderPlayerTime();
  }
}

function renderPlayer(){
  let el = document.getElementById('player');
  if(!el){
    el = document.createElement('div'); el.id='player';
    el.className='card'; el.style.position='fixed'; el.style.right='16px'; el.style.bottom='16px'; el.style.width='340px';
    document.body.appendChild(el);
  }

  const next = timerState.clock.stages[timerState.idx + 1];
  el.innerHTML = `
    <div class="row" style="justify-content:space-between;">
      <div>
        <strong>${timerState.clock.name}</strong>
        <div class="muted">回合 ${timerState.loop}/${timerState.clock.repeat_count||1}</div>
      </div>
      <div class="row">
        <button class="btn secondary" onclick="prevStage()">◀</button>
        <button class="btn secondary" onclick="nextStage()">▶</button>
        <button class="btn secondary" onclick="toggleFullscreen()">⛶ 最大化</button>
        <button id="pause-resume-btn" class="btn" onclick="togglePause()">⏸ 暫停</button>
        <button class="btn danger" onclick="stopPlayer()">停止</button>
      </div>
    </div>

    <div class="time" id="remain-txt" style="text-align:center; margin-top:6px;">${timerState.remain}s</div>
    <div class="muted  stage-title" id="stage-name" style="text-align:center;">
      ${(timerState.clock.stages[timerState.idx].name||'').trim()||'Stage'}
    </div>
    <div class="muted  next-label" style="text-align:center; font-size:12px;">
      下一段：<span id="next-name">${next ? (next.name||'未命名') : '完成'}</span>
    </div>
  `;
}

function fsElement() {
  return document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement || null;
}
async function enterFullscreen(el) {
  const req = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen;
  if (!req) return false;
  try {
    await req.call(el);
    return true;
  } catch (e) {
    return false;
  }
}
async function exitFullscreen() {
  const exit = document.exitFullscreen || document.webkitExitFullscreen || document.msExitFullscreen;
  if (!exit) return;
  try { await exit.call(document); } catch(e) {}
}

async function toggleFullscreen() {
  const el = document.getElementById('player');
  if (!fsElement()) {
    const ok = await enterFullscreen(el);
    if (!ok) {
      // Safari 失敗 → fallback：劇院模式
      document.body.classList.add('no-scroll');
      el.classList.add('theater');
    }
  } else {
    await exitFullscreen();
    document.body.classList.remove('no-scroll');
    el.classList.remove('theater');
  }
}

// 讓按下 Esc 或系統退出全螢幕時，自動移除劇院模式
function onFSChange() {
  if (!fsElement()) {
    document.body.classList.remove('no-scroll');
    const el = document.getElementById('player');
    if (el) el.classList.remove('theater');
  }
}
document.addEventListener('fullscreenchange', onFSChange);
document.addEventListener('webkitfullscreenchange', onFSChange);

function renderPlayerTime(){
  const el = document.getElementById('remain-txt');
  if(el) el.textContent = `${timerState.remain}s`;

  const nm = document.getElementById('stage-name');
  if(nm) nm.textContent = (timerState.clock.stages[timerState.idx].name||'').trim()||'Stage';

  const nextEl = document.getElementById('next-name');
  if(nextEl){
    const next = timerState.clock.stages[timerState.idx + 1];
    nextEl.textContent = next ? (next.name || '未命名') : '完成';
  }
}

function prevStage(){
  const {clock} = timerState;
  timerState.idx -= 1;
  if(timerState.idx < 0){
    if(timerState.loop>1){
      timerState.loop -= 1;
      timerState.idx = clock.stages.length-1;
    }else{
      timerState.idx = 0;
    }
  }
  const s = clock.stages[timerState.idx];
  timerState.remain = s.duration_sec;
  renderPlayer();
}

let isPaused = false;

function togglePause() {
  isPaused = !isPaused;
  const btn = document.getElementById('pause-resume-btn');
  btn.textContent = isPaused ? '▶️ 繼續' : '⏸ 暫停';
}


async function init(){
  try{
    await fetchCurrentUser();
    await loadCommunity();
    await loadMine();
  }catch(err){
    console.error(err);
  }
}

init();

// Enter search
$('#search').addEventListener('keydown', e=>{
  if(e.key==='Enter'){
    // client side filter for MVP: refetch and filter
    loadCommunity().then(()=>{
      const q = $('#search').value.toLowerCase();
      const grid = $('#community-grid');
      [...grid.children].forEach(card=>{
        const name = card.querySelector('div div[style] strong, .name');
      });
    });
  }
});
</script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
  new Sortable(document.getElementById('stage-list'), {
    handle: '.drag-handle',
    animation: 150,
    onEnd: function (evt) {
      const newOrder = [];
      document.querySelectorAll('#stage-list .stage-item').forEach(el => {
        const oldIndex = parseInt(el.dataset.index);
        newOrder.push(currentClock.stages[oldIndex]);
      });
      currentClock.stages = newOrder;
      renderStages();
    }
  });
</script>
</body>
</html>
